<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Realtime Polls</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        .form-input {
            width: 100%;
            padding: 12px;
            margin-bottom: 16px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            box-sizing: border-box;
        }
        .button {
            padding: 12px 24px;
            font-weight: 600;
            border-radius: 8px;
            transition: background-color 0.2s;
        }
        .button-primary {
            background-color: #4f46e5;
            color: white;
            border: none;
        }
        .button-primary:hover {
            background-color: #4338ca;
        }
        .button-secondary {
            background-color: #e5e7eb;
            color: #4b5563;
            border: 1px solid #d1d5db;
        }
        .button-secondary:hover {
            background-color: #d1d5db;
        }
        .vote-option:hover {
            background-color: #e5e7eb;
        }
        .option-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .delete-btn {
            background-color: #fca5a5;
            color: white;
            padding: 6px 10px;
            border-radius: 6px;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        .delete-btn:hover {
            background-color: #ef4444;
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #4f46e5;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <div id="app" class="container bg-white p-8 rounded-xl shadow-lg w-full">
        <!-- Auth/Create Poll Section -->
        <div id="auth-create-section" class="space-y-6">
            <h1 class="text-4xl font-bold text-center text-gray-800">Create a Poll</h1>
            <p id="auth-status" class="text-center text-sm text-gray-600">Please sign in to create a poll.</p>
            <div id="auth-buttons" class="flex justify-center">
                <button id="google-signin" class="button button-primary">Sign in with Google</button>
                <button id="signout" class="hidden button button-secondary ml-4">Sign out</button>
            </div>

            <form id="poll-form" class="mt-8 hidden space-y-4">
                <h2 class="text-2xl font-semibold text-gray-800">Your Question</h2>
                <input id="poll-question" type="text" placeholder="e.g., What's your favorite color?" class="form-input" required>
                
                <h2 class="text-2xl font-semibold text-gray-800">Options</h2>
                <div id="options-container" class="space-y-4">
                    <div class="option-group">
                        <input type="text" placeholder="Option 1" class="form-input poll-option" required>
                    </div>
                    <div class="option-group">
                        <input type="text" placeholder="Option 2" class="form-input poll-option" required>
                    </div>
                </div>
                <div class="flex flex-col sm:flex-row justify-between items-center gap-4 mt-4">
                    <div class="flex items-center gap-4">
                        <button type="button" id="add-option" class="text-indigo-600 hover:text-indigo-800 font-medium">+ Add another option</button>
                        <button type="button" id="create-poll-ai-btn" class="button button-secondary">
                            Create with AI
                        </button>
                    </div>
                    <button type="submit" class="button button-primary w-full sm:w-auto">Create Poll</button>
                </div>
                <div id="ai-loading-status" class="text-center mt-4 text-sm text-gray-500 hidden">
                    <div class="flex items-center justify-center gap-2">
                        <div class="spinner"></div>
                        <span>Generating poll...</span>
                    </div>
                </div>
            </form>

            <div id="poll-link-section" class="hidden mt-8 text-center bg-gray-50 p-6 rounded-lg border border-dashed border-gray-200">
                <p class="text-lg font-medium text-gray-700">Your poll has been created!</p>
                <a id="poll-link" class="text-indigo-600 hover:underline break-words mt-2 block" target="_blank" href=""></a>
            </div>
        </div>

        <!-- View/Vote Poll Section -->
        <div id="poll-view-section" class="hidden space-y-6">
            <h1 class="text-3xl font-bold text-center text-gray-800 mb-2">
                <span id="poll-question-display"></span>
                <span id="poll-status-indicator" class="text-sm font-semibold ml-2"></span>
            </h1>
            <div id="poll-options-display" class="space-y-4 mt-6">
                <!-- Poll options will be dynamically added here -->
            </div>
            <div id="poll-results-display" class="hidden mt-8">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Results</h2>
                <div id="results-list" class="space-y-2">
                    <!-- Poll results will be dynamically added here -->
                </div>
            </div>
            
            <!-- Poll management buttons for the owner -->
            <div id="owner-buttons" class="hidden mt-8 flex justify-center space-x-4">
                <button id="toggle-poll-btn" class="button bg-yellow-500 hover:bg-yellow-600 text-white">End Poll</button>
                <button id="delete-poll-btn" class="button bg-red-500 hover:bg-red-600 text-white">Delete Poll</button>
            </div>

            <div class="mt-8 text-center">
                <a href="/" class="text-indigo-600 hover:underline">Create your own poll</a>
            </div>
        </div>

        <p id="error-message" class="text-center text-red-500 mt-4"></p>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
        import { getDatabase, ref, push, onValue, runTransaction, set, update, remove } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js";
        import { getAI, getGenerativeModel, GoogleAIBackend } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-ai.js";
        
        // Firebase configuration from user's request
        const firebaseConfig = {
            apiKey: "AIzaSyD4Nvk8ufVAw_0EB2lZTdAkZKSWSnWbKtc",
            authDomain: "polltime-6ec9c.firebaseapp.com",
            projectId: "polltime-6ec9c",
            storageBucket: "polltime-6ec9c.firebaseapp.com",
            messagingSenderId: "73413033282",
            appId: "1:73413033282:web:27934aa47c300f02871cdb",
            measurementId: "G-V49J0KF4FZ"
        };
    
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        // Initialize the Gemini Developer API backend service
        const ai = getAI(app, { backend: new GoogleAIBackend() });
        const model = getGenerativeModel(ai, { model: "gemini-1.5-flash-preview-05-20" });

        // UI elements
        const authCreateSection = document.getElementById('auth-create-section');
        const pollViewSection = document.getElementById('poll-view-section');
        const authStatus = document.getElementById('auth-status');
        const googleSigninBtn = document.getElementById('google-signin');
        const signoutBtn = document.getElementById('signout');
        const pollForm = document.getElementById('poll-form');
        const optionsContainer = document.getElementById('options-container');
        const addOptionBtn = document.getElementById('add-option');
        const pollLinkSection = document.getElementById('poll-link-section');
        const pollLink = document.getElementById('poll-link');
        const pollQuestionDisplay = document.getElementById('poll-question-display');
        const pollStatusIndicator = document.getElementById('poll-status-indicator');
        const pollOptionsDisplay = document.getElementById('poll-options-display');
        const pollResultsDisplay = document.getElementById('poll-results-display');
        const resultsList = document.getElementById('results-list');
        const errorMessage = document.getElementById('error-message');
        const ownerButtons = document.getElementById('owner-buttons');
        const togglePollBtn = document.getElementById('toggle-poll-btn');
        const deletePollBtn = document.getElementById('delete-poll-btn');
        const createPollAiBtn = document.getElementById('create-poll-ai-btn');
        const pollQuestionInput = document.getElementById('poll-question');
        const aiLoadingStatus = document.getElementById('ai-loading-status');

        
        // State for the current poll ID
        let currentPollId = null;

        // Handle URL-based routing to show the create or view section
        const handleRouting = () => {
            const path = window.location.pathname;
            if (path.startsWith('/poll/')) {
                const parts = path.split('/');
                currentPollId = parts[parts.length - 1];
                
                if (currentPollId) {
                    authCreateSection.classList.add('hidden');
                    pollViewSection.classList.remove('hidden');
                    fetchPollData(currentPollId);
                } else {
                    pollQuestionDisplay.textContent = 'Poll not found. Invalid URL.';
                    pollOptionsDisplay.innerHTML = '';
                    pollResultsDisplay.classList.add('hidden');
                }
            } else {
                authCreateSection.classList.remove('hidden');
                pollViewSection.classList.add('hidden');
            }
        };

        // Listen for auth state changes
        onAuthStateChanged(auth, (user) => {
            if (user) {
                authStatus.textContent = `Signed in as ${user.displayName}. You can now create a poll.`;
                googleSigninBtn.classList.add('hidden');
                signoutBtn.classList.remove('hidden');
                pollForm.classList.remove('hidden');
            } else {
                authStatus.textContent = 'Please sign in to create a poll.';
                googleSigninBtn.classList.remove('hidden');
                signoutBtn.classList.add('hidden');
                pollForm.classList.add('hidden');
            }
            if (currentPollId) {
                fetchPollData(currentPollId);
            }
        });

        // Event listeners
        googleSigninBtn.addEventListener('click', async () => {
            try {
                const provider = new GoogleAuthProvider();
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Authentication error:", error);
                errorMessage.textContent = 'Failed to sign in. Please try again.';
            }
        });

        signoutBtn.addEventListener('click', async () => {
            try {
                await signOut(auth);
                errorMessage.textContent = '';
            } catch (error) {
                console.error("Sign out error:", error);
                errorMessage.textContent = 'Failed to sign out. Please try again.';
            }
        });

        addOptionBtn.addEventListener('click', () => {
            const optionGroup = document.createElement('div');
            optionGroup.className = 'option-group';

            const newOption = document.createElement('input');
            newOption.type = 'text';
            newOption.placeholder = `Option ${optionsContainer.children.length + 1}`;
            newOption.className = 'form-input poll-option';
            newOption.required = true;
            
            const deleteBtn = document.createElement('button');
            deleteBtn.textContent = 'x';
            deleteBtn.type = 'button';
            deleteBtn.className = 'delete-btn';
            deleteBtn.title = 'Remove this option';
            deleteBtn.onclick = () => {
                optionGroup.remove();
            };

            optionGroup.appendChild(newOption);
            optionGroup.appendChild(deleteBtn);
            optionsContainer.appendChild(optionGroup);
        });

        // New functionality: Create a poll using AI
        createPollAiBtn.addEventListener('click', async () => {
            const topic = window.prompt("What topic would you like the poll to be about?");
            if (!topic) {
                return;
            }

            aiLoadingStatus.classList.remove('hidden');
            errorMessage.textContent = '';

            try {
                const systemPrompt = "You are an expert poll creator. Your task is to generate a compelling poll question and a list of at least 4 distinct options based on a given topic. The response MUST be a valid JSON object with a 'question' and an 'options' array. Do not include any other text or formatting. The options should be concise and relevant to the question.";
                const userQuery = `Create a poll about: ${topic}.`;

                const payload = {
                    contents: [{ parts: [{ text: userQuery }] }],
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "OBJECT",
                            properties: {
                                "question": { "type": "STRING" },
                                "options": {
                                    "type": "ARRAY",
                                    "items": { "type": "STRING" }
                                }
                            }
                        }
                    }
                };
                
                // Use the Firebase AI SDK instead of a direct fetch call
                const result = await model.generateContent(payload);
                const jsonText = result?.response?.text() || "";

                if (!jsonText) {
                    throw new Error("Invalid response from AI model.");
                }

                const pollData = JSON.parse(jsonText);

                // Populate the form
                pollQuestionInput.value = pollData.question;
                optionsContainer.innerHTML = '';
                pollData.options.forEach((optionText, index) => {
                    const optionGroup = document.createElement('div');
                    optionGroup.className = 'option-group';
                    const newOption = document.createElement('input');
                    newOption.type = 'text';
                    newOption.placeholder = `Option ${index + 1}`;
                    newOption.className = 'form-input poll-option';
                    newOption.value = optionText;
                    newOption.required = true;

                    const deleteBtn = document.createElement('button');
                    deleteBtn.textContent = 'x';
                    deleteBtn.type = 'button';
                    deleteBtn.className = 'delete-btn';
                    deleteBtn.title = 'Remove this option';
                    deleteBtn.onclick = () => {
                        optionGroup.remove();
                    };

                    optionGroup.appendChild(newOption);
                    optionGroup.appendChild(deleteBtn);
                    optionsContainer.appendChild(optionGroup);
                });

            } catch (error) {
                console.error("AI poll generation failed:", error);
                errorMessage.textContent = 'Failed to generate poll. Please try a different topic.';
            } finally {
                aiLoadingStatus.classList.add('hidden');
            }
        });

        pollForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const user = auth.currentUser;
            if (!user) {
                errorMessage.textContent = 'You must be signed in to create a poll.';
                return;
            }

            const question = document.getElementById('poll-question').value;
            const options = Array.from(document.querySelectorAll('.poll-option'))
                                 .map(input => input.value.trim())
                                 .filter(val => val !== '');

            if (options.length < 2) {
                errorMessage.textContent = 'Please provide at least two options.';
                return;
            }

            const pollData = {
                question,
                creatorUid: user.uid,
                isEnded: false,
                timestamp: Date.now(),
                options: options.map(option => ({ text: option, votes: 0 }))
            };

            try {
                const pollsRef = ref(db, 'polls');
                const newPollRef = push(pollsRef);
                const pollId = newPollRef.key;
                
                const pollUrl = `${window.location.origin}/poll/${pollId}`;

                await set(newPollRef, pollData);

                pollForm.classList.add('hidden');
                pollLinkSection.classList.remove('hidden');
                pollLink.textContent = pollUrl;
                pollLink.href = pollUrl;
                errorMessage.textContent = '';
            } catch (error) {
                console.error("Failed to create poll:", error);
                errorMessage.textContent = 'Failed to create poll. Please try again.';
            }
        });

        // Event listeners for owner-only buttons
        togglePollBtn.addEventListener('click', async () => {
            if (!currentPollId) return;
            const pollRef = ref(db, `polls/${currentPollId}`);
            try {
                // Fetch the current state to toggle it
                onValue(pollRef, async (snapshot) => {
                    const poll = snapshot.val();
                    if (poll) {
                        await update(pollRef, { isEnded: !poll.isEnded });
                    }
                }, { onlyOnce: true });
            } catch (error) {
                console.error("Failed to toggle poll status:", error);
                errorMessage.textContent = 'Failed to change poll status. Please try again.';
            }
        });
        
        deletePollBtn.addEventListener('click', async () => {
            if (!currentPollId) return;
            try {
                await remove(ref(db, `polls/${currentPollId}`));
                window.location.href = '/'; // Redirect after deletion
            } catch (error) {
                console.error("Failed to delete poll:", error);
                errorMessage.textContent = 'Failed to delete poll. Please try again.';
            }
        });

        // Fetch and display poll data
        const fetchPollData = (pollId) => {
            const pollRef = ref(db, `polls/${pollId}`);
            
            onValue(pollRef, (snapshot) => {
                const poll = snapshot.val();
                
                if (poll) {
                    poll.key = snapshot.key;
                    pollQuestionDisplay.textContent = poll.question;
                    
                    // Show or hide owner buttons based on creator ID
                    const user = auth.currentUser;
                    if (user && user.uid === poll.creatorUid) {
                        ownerButtons.classList.remove('hidden');
                        updateOwnerButtons(poll);
                    } else {
                        ownerButtons.classList.add('hidden');
                    }

                    updatePollStatusDisplay(poll);
                    renderPollOptions(poll);
                } else {
                    pollQuestionDisplay.textContent = 'Poll not found.';
                    pollOptionsDisplay.innerHTML = '';
                    pollResultsDisplay.classList.add('hidden');
                    ownerButtons.classList.add('hidden');
                }
            }, {
                onlyOnce: false
            });
        };

        const updatePollStatusDisplay = (poll) => {
            const now = Date.now();
            const fiveMinutes = 5 * 60 * 1000;
            pollStatusIndicator.className = 'text-sm font-semibold ml-2'; // Reset classes

            if (poll.isEnded) {
                pollStatusIndicator.textContent = 'Poll Ended';
                pollStatusIndicator.classList.add('text-red-500');
            } else if (now - poll.timestamp < fiveMinutes) {
                pollStatusIndicator.textContent = 'Poll Ongoing • New';
                pollStatusIndicator.classList.add('text-blue-500');
            } else {
                pollStatusIndicator.textContent = 'Poll Ongoing';
                pollStatusIndicator.classList.add('text-green-500');
            }
        };

        const updateOwnerButtons = (poll) => {
            if (poll.isEnded) {
                togglePollBtn.textContent = 'Start Poll';
                togglePollBtn.classList.remove('bg-yellow-500', 'hover:bg-yellow-600');
                togglePollBtn.classList.add('bg-green-500', 'hover:bg-green-600');
            } else {
                togglePollBtn.textContent = 'End Poll';
                togglePollBtn.classList.remove('bg-green-500', 'hover:bg-green-600');
                togglePollBtn.classList.add('bg-yellow-500', 'hover:bg-yellow-600');
            }
        };

        // Render poll options and results
        const renderPollOptions = (poll) => {
            pollOptionsDisplay.innerHTML = '';
            resultsList.innerHTML = '';
            const totalVotes = poll.options.reduce((sum, option) => sum + option.votes, 0);

            poll.options.forEach((option, index) => {
                const optionButton = document.createElement('button');
                optionButton.textContent = option.text;
                optionButton.className = 'vote-option button button-secondary w-full text-left';
                
                if (poll.isEnded) {
                    optionButton.disabled = true;
                    optionButton.classList.add('bg-gray-200', 'cursor-not-allowed');
                } else {
                    optionButton.addEventListener('click', () => {
                        vote(poll.key, index);
                    });
                }
                pollOptionsDisplay.appendChild(optionButton);

                const resultBar = document.createElement('div');
                const percentage = totalVotes > 0 ? (option.votes / totalVotes * 100) : 0;
                resultBar.innerHTML = `
                    <div class="flex justify-between items-center text-gray-700">
                        <span>${option.text}</span>
                        <span>${option.votes} votes (${percentage.toFixed(1)}%)</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2.5 mt-1">
                        <div class="bg-indigo-600 h-2.5 rounded-full" style="width: ${percentage}%;"></div>
                    </div>
                `;
                resultsList.appendChild(resultBar);
            });
            
            if (totalVotes > 0 || poll.isEnded) {
                pollResultsDisplay.classList.remove('hidden');
            } else {
                pollResultsDisplay.classList.add('hidden');
            }
        };

        // Handle voting
        const vote = (pollId, optionIndex) => {
            const pollOptionVotesRef = ref(db, `polls/${pollId}/options/${optionIndex}/votes`);
            
            runTransaction(pollOptionVotesRef, (currentVotes) => {
                return (currentVotes || 0) + 1;
            });
        };

        window.onload = handleRouting;
        window.addEventListener('popstate', handleRouting);
    </script>
</body>
</html>

